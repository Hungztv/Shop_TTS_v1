# ============================================================================

# ANTIGRAVITY RULES - ShopxBase Vibe Coding Project

# Tech Stack: .NET 8 (Clean Architecture) + Supabase + Next.js 16

# ============================================================================

# ƒê√¢y l√† file quy t·∫Øc cho AI/Copilot khi l√†m vi·ªác v·ªõi d·ª± √°n

# ƒê·∫£m b·∫£o t√≠nh b·ªÅn v·ªØng (Sustainability), b·∫£o tr√¨ (Maintainability), m·ªü r·ªông (Scalability)

# ============================================================================

## üéØ PROJECT OVERVIEW

project_name: ShopxBase
description: E-commerce platform v·ªõi Clean Architecture
tech_stack:
backend: .NET 8, Entity Framework Core, MediatR (CQRS), FluentValidation
database: Supabase (PostgreSQL)
frontend: Next.js 16, React 19, TypeScript, Tailwind CSS 4
auth: Supabase Auth + JWT

## üìÅ ARCHITECTURE RULES

### Backend - Clean Architecture Layers

```
backend/
‚îú‚îÄ‚îÄ ShopxBase.Api/           # Presentation Layer - Controllers, Middlewares
‚îú‚îÄ‚îÄ ShopxBase.Application/   # Application Layer - CQRS, DTOs, Interfaces
‚îú‚îÄ‚îÄ ShopxBase.Domain/        # Domain Layer - Entities, Enums, Exceptions
‚îî‚îÄ‚îÄ ShopxBase.Infrastructure/# Infrastructure Layer - EF Core, External Services
```

rules:

- Domain layer KH√îNG ƒë∆∞·ª£c ph·ª• thu·ªôc v√†o b·∫•t k·ª≥ layer n√†o kh√°c
- Application layer ch·ªâ ph·ª• thu·ªôc Domain layer
- Infrastructure layer ph·ª• thu·ªôc Application v√† Domain
- API layer ph·ª• thu·ªôc Application (v√† Infrastructure qua DI)

### Frontend - Feature-Based Structure

```
frontend/
‚îú‚îÄ‚îÄ app/                     # Next.js App Router
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îú‚îÄ‚îÄ ui/                  # Reusable UI components (shadcn/ui style)
‚îÇ   ‚îî‚îÄ‚îÄ layout/              # Layout components (Header, Footer, Sidebar)
‚îú‚îÄ‚îÄ features/                # Feature-specific components & hooks
‚îú‚îÄ‚îÄ lib/                     # Utilities, API client, helpers
‚îú‚îÄ‚îÄ hooks/                   # Global custom hooks
‚îú‚îÄ‚îÄ stores/                  # State management (Zustand recommended)
‚îî‚îÄ‚îÄ types/                   # TypeScript type definitions
```

## üîß CODING CONVENTIONS

### C# / .NET Backend

naming:
classes: PascalCase (ProductService, OrderController)
interfaces: I prefix + PascalCase (IProductRepository)
methods: PascalCase (GetProductById, CreateOrder)
private_fields: \_camelCase (\_productRepository)
constants: UPPER_SNAKE_CASE ho·∫∑c PascalCase
async_methods: Suffix v·ªõi Async (GetProductByIdAsync)

file_organization:

- M·ªói class/interface trong 1 file ri√™ng
- File name = Class name (ProductService.cs)
- CQRS: Commands v√† Queries trong folders ri√™ng bi·ªát

patterns:

- S·ª≠ d·ª•ng CQRS v·ªõi MediatR cho t·∫•t c·∫£ business logic
- Repository Pattern cho data access
- Unit of Work pattern cho transactions
- Dependency Injection cho t·∫•t c·∫£ dependencies

### TypeScript / Next.js Frontend

naming:
components: PascalCase (ProductCard.tsx, Header.tsx)
hooks: camelCase v·ªõi prefix use (useProducts, useAuth)
utilities: camelCase (formatPrice, validateEmail)
types: PascalCase (ProductDto, ApiResponse)
constants: UPPER_SNAKE_CASE (API_BASE_URL)

file_organization:

- Components: ComponentName.tsx
- Server Components m·∫∑c ƒë·ªãnh, ch·ªâ th√™m 'use client' khi c·∫ßn
- Colocate related files (component, styles, tests)

patterns:

- Server Components cho data fetching
- Client Components ch·ªâ khi c·∫ßn interactivity
- Custom hooks cho reusable logic
- Compound components cho complex UI

## üìù CQRS PATTERN TEMPLATE

### Command Template (Create/Update/Delete)

```csharp
// Location: ShopxBase.Application/Features/{Feature}/Commands/{Action}/

// 1. Command
public record {Action}{Feature}Command : IRequest<{ResponseType}>
{
    // Properties
}

// 2. Validator
public class {Action}{Feature}CommandValidator : AbstractValidator<{Action}{Feature}Command>
{
    public {Action}{Feature}CommandValidator()
    {
        // Validation rules
    }
}

// 3. Handler
public class {Action}{Feature}CommandHandler : IRequestHandler<{Action}{Feature}Command, {ResponseType}>
{
    private readonly IApplicationDbContext _context;

    public {Action}{Feature}CommandHandler(IApplicationDbContext context)
    {
        _context = context;
    }

    public async Task<{ResponseType}> Handle({Action}{Feature}Command request, CancellationToken cancellationToken)
    {
        // Implementation
    }
}
```

### Query Template (Read)

```csharp
// Location: ShopxBase.Application/Features/{Feature}/Queries/{Action}/

// 1. Query
public record {Action}Query : IRequest<{ResponseType}>
{
    // Parameters
}

// 2. Handler
public class {Action}QueryHandler : IRequestHandler<{Action}Query, {ResponseType}>
{
    private readonly IApplicationDbContext _context;

    public async Task<{ResponseType}> Handle({Action}Query request, CancellationToken cancellationToken)
    {
        // Implementation with .AsNoTracking()
    }
}
```

## üóÑÔ∏è DATABASE & ENTITY RULES

### Entity Template

```csharp
// Location: ShopxBase.Domain/Entities/

public class {EntityName} : BaseEntity
{
    // Properties
    public string Name { get; set; } = string.Empty;

    // Navigation properties
    public virtual ICollection<RelatedEntity> RelatedEntities { get; set; } = new List<RelatedEntity>();
}
```

### BaseEntity Properties (T·ª± ƒë·ªông c√≥)

```csharp
public int Id { get; set; }
public DateTime CreatedAt { get; set; }
public DateTime? UpdatedAt { get; set; }
public bool IsDeleted { get; set; }  // Soft delete
```

### Supabase Integration Rules

- S·ª≠ d·ª•ng Supabase Auth cho authentication
- Sync users gi·ªØa Supabase Auth v√† database qua triggers
- Row Level Security (RLS) cho sensitive data
- Supabase Storage cho file uploads

## üîê SECURITY RULES

authentication:

- Supabase JWT tokens cho frontend authentication
- Validate JWT v·ªõi Supabase JWKS endpoint
- Custom JWT cho internal services (optional)

authorization:

- Role-based: Admin, Seller, Customer
- [Authorize] attribute cho protected endpoints
- [AllowAnonymous] cho public endpoints

data_protection:

- Soft delete (IsDeleted = true) thay v√¨ hard delete
- Kh√¥ng log sensitive data (passwords, tokens)
- Validate t·∫•t c·∫£ input v·ªõi FluentValidation
- Parameterized queries (EF Core t·ª± ƒë·ªông)

## üìä DTO & RESPONSE PATTERNS

### Standard API Response

```csharp
public class ApiResponse<T>
{
    public bool Success { get; set; }
    public string Message { get; set; }
    public T? Data { get; set; }
    public List<string>? Errors { get; set; }
}
```

### Pagination Response

```csharp
public class PaginationResponse<T>
{
    public List<T> Items { get; set; }
    public int PageNumber { get; set; }
    public int PageSize { get; set; }
    public int TotalCount { get; set; }
    public int TotalPages { get; set; }
    public bool HasPreviousPage { get; set; }
    public bool HasNextPage { get; set; }
}
```

### DTO Naming Convention

- {Entity}Dto - Full entity representation
- {Entity}ListDto - Minimal for list views
- {Entity}DetailDto - Detailed with relations
- Create{Entity}Dto - For creation
- Update{Entity}Dto - For updates

## üé® FRONTEND COMPONENT PATTERNS

### React Component Template

```tsx
// Server Component (default)
interface {ComponentName}Props {
  // Props definition
}

export default async function {ComponentName}({ props }: {ComponentName}Props) {
  // Data fetching here
  return (
    <div>
      {/* JSX */}
    </div>
  );
}
```

```tsx
// Client Component (when needed)
'use client';

import { useState, useEffect } from 'react';

interface {ComponentName}Props {
  // Props definition
}

export function {ComponentName}({ props }: {ComponentName}Props) {
  const [state, setState] = useState();

  return (
    <div>
      {/* JSX */}
    </div>
  );
}
```

### API Client Pattern

```typescript
// lib/api-client.ts
import axios from "axios";

export const apiClient = axios.create({
  baseURL: process.env.NEXT_PUBLIC_API_URL,
  headers: { "Content-Type": "application/json" },
});

// Interceptors for auth token
apiClient.interceptors.request.use((config) => {
  const token = getAuthToken();
  if (token) {
    config.headers.Authorization = `Bearer ${token}`;
  }
  return config;
});
```

## ‚ö° PERFORMANCE GUIDELINES

### Backend

- AsNoTracking() cho read-only queries
- Pagination b·∫Øt bu·ªôc cho list endpoints
- Select() ch·ªâ columns c·∫ßn thi·∫øt
- Include() ch·ªâ relations c·∫ßn thi·∫øt
- S·ª≠ d·ª•ng compiled queries cho hot paths
- Connection pooling v·ªõi Supabase

### Frontend

- Server Components m·∫∑c ƒë·ªãnh
- Lazy loading cho heavy components
- Image optimization v·ªõi next/image
- Code splitting t·ª± ƒë·ªông v·ªõi App Router
- Memoization v·ªõi useMemo/useCallback khi c·∫ßn

## üß™ TESTING CONVENTIONS

### Backend Tests

```
tests/
‚îú‚îÄ‚îÄ ShopxBase.UnitTests/           # Unit tests for Application layer
‚îú‚îÄ‚îÄ ShopxBase.IntegrationTests/    # Integration tests with database
‚îî‚îÄ‚îÄ ShopxBase.FunctionalTests/     # End-to-end API tests
```

### Frontend Tests

- Component tests v·ªõi React Testing Library
- E2E tests v·ªõi Playwright (recommended)
- Unit tests cho utilities v√† hooks

## üì¶ DEPENDENCY RULES

### Backend NuGet Packages

```
- MediatR (CQRS)
- FluentValidation (Validation)
- AutoMapper (Object mapping)
- Npgsql.EntityFrameworkCore.PostgreSQL (Database)
- Microsoft.AspNetCore.Authentication.JwtBearer (Auth)
- Supabase (Supabase client)
```

### Frontend npm Packages

```
- next (Framework)
- react, react-dom (UI)
- axios (HTTP client)
- tailwindcss (Styling)
- lucide-react (Icons)
- class-variance-authority, clsx, tailwind-merge (Utility)
- @supabase/supabase-js (Supabase client)
- zustand (State management - recommended)
- react-hook-form + zod (Forms - recommended)
```

## üöÄ DEPLOYMENT & ENVIRONMENT

### Environment Variables

```
# Backend (.env)
SUPABASE_HOST=
SUPABASE_PORT=
SUPABASE_DATABASE=
SUPABASE_USER=
SUPABASE_PASSWORD=
SUPABASE_URL=
SUPABASE_ANON_KEY=
SUPABASE_JWT_SECRET=
JWT_SECRET=
JWT_ISSUER=
JWT_AUDIENCE=

# Frontend (.env.local)
NEXT_PUBLIC_API_URL=
NEXT_PUBLIC_SUPABASE_URL=
NEXT_PUBLIC_SUPABASE_ANON_KEY=
```

### Docker Support (Recommended)

```yaml
# docker-compose.yml structure
services:
  api:
    build: ./backend
    ports: ["5000:80"]
  web:
    build: ./frontend
    ports: ["3000:3000"]
```

## üìã GIT CONVENTIONS

### Branch Naming

- feature/{feature-name}
- bugfix/{bug-description}
- hotfix/{hotfix-description}
- release/{version}

### Commit Messages

```
feat: Add new feature
fix: Fix bug
docs: Documentation changes
style: Code style changes (formatting)
refactor: Code refactoring
test: Add/update tests
chore: Build/config changes
```

## ‚ö†Ô∏è ANTI-PATTERNS TO AVOID

### Backend

- ‚ùå Business logic trong Controllers
- ‚ùå Direct database access trong API layer
- ‚ùå Hard-coded connection strings
- ‚ùå Synchronous database calls
- ‚ùå N+1 query problems
- ‚ùå Returning entities directly (use DTOs)
- ‚ùå Catching generic Exception without handling

### Frontend

- ‚ùå 'use client' khi kh√¥ng c·∫ßn thi·∫øt
- ‚ùå Prop drilling s√¢u (use context/state management)
- ‚ùå Inline styles thay v√¨ Tailwind classes
- ‚ùå Direct DOM manipulation
- ‚ùå Hardcoded API URLs
- ‚ùå Missing loading/error states

## ‚úÖ CHECKLIST FOR NEW FEATURES

### Backend Checklist

- [ ] Entity trong Domain layer
- [ ] DTOs trong Application layer
- [ ] Command/Query v·ªõi Handler
- [ ] Validator cho Commands
- [ ] Controller endpoint
- [ ] Authorization attribute
- [ ] Unit tests

### Frontend Checklist

- [ ] TypeScript types
- [ ] Component v·ªõi proper props
- [ ] Loading state
- [ ] Error handling
- [ ] Responsive design
- [ ] Accessibility (ARIA)
- [ ] Tests

## üîÑ MIGRATION GUIDELINES

### Database Migrations

```bash
# Add migration
dotnet ef migrations add {MigrationName} -p ShopxBase.Infrastructure -s ShopxBase.Api

# Update database
dotnet ef database update -p ShopxBase.Infrastructure -s ShopxBase.Api
```

### Breaking Changes

- Bump API version (v1 -> v2)
- Deprecation warnings tr∆∞·ªõc khi remove
- Migration scripts cho data changes

---

# END OF ANTIGRAVITY RULES

# Tu√¢n th·ªß c√°c quy t·∫Øc n√†y ƒë·ªÉ ƒë·∫£m b·∫£o code quality v√† team consistency
